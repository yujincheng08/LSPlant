<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LSPlant: LSPlant</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">LSPlant
   &#160;<span id="projectnumber">LSPosed Developers</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">LSPlant </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><object type="image/svg+xml" data="https://img.shields.io/badge/license-LGPL--3.0-orange.svg" style="pointer-events: none;"></object> <object type="image/svg+xml" data="https://img.shields.io/badge/Android-6.0%20--%2013-blue.svg" style="pointer-events: none;"></object> <object type="image/svg+xml" data="https://img.shields.io/badge/arch-armeabi--v7a%20%7C%20arm64--v8a%20%7C%20x86%20%7C%20x86--64-brightgreen.svg" style="pointer-events: none;"></object> <object type="image/svg+xml" data="https://github.com/LSPosed/LSPlant/actions/workflows/build.yml/badge.svg?branch=master&amp;event=push" style="pointer-events: none;"></object> <img src="https://img.shields.io/maven-central/v/org.lsposed.lsplant/lsplant" alt="" class="inline"/></p>
<p>LSPlant is an Android ART hook library, providing Java method hook/unhook and inline deoptimization.</p>
<p>This project is part of LSPosed framework under GNU Lesser General Public License.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Features</h1>
<ul>
<li>Support Android 6.0 - 13 (API level 23 - 34)</li>
<li>Support armeabi-v7a, arm64-v8a, x86, x86-64</li>
<li>Support customized inline hook framework and ART symbol resolver</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
Documentation</h1>
<p><a href="https://lsposed.org/LSPlant/namespacelsplant.html">https://lsposed.org/LSPlant/namespacelsplant.html</a></p>
<h1><a class="anchor" id="autotoc_md3"></a>
Quick Start</h1>
<div class="fragment"><div class="line">repositories {</div>
<div class="line">    mavenCentral()</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">dependencies {</div>
<div class="line">    implementation &quot;org.lsposed.lsplant:lsplant:2.0&quot;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">android {</div>
<div class="line">    buildFeatures {</div>
<div class="line">        prefab true</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4"></a>
1. Init LSPlant within JNI_OnLoad</h2>
<p>Initialize LSPlant for the proceeding hook. It mainly prefetch needed symbols and hook some functions.</p>
<ul>
<li><code>env</code> is the Java environment.</li>
<li><p class="startli"><code>info</code> is the information for initialized.</p>
<p class="startli">Basically, the info provides the inline hooker and unhooker together with a symbol resolver of <code>libart.so</code> to hook and extract needed native functions of ART.</p>
</li>
</ul>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">bool Init(JNIEnv *env,</div>
<div class="line">          const InitInfo &amp;info);</div>
</div><!-- fragment --><p>Returns whether initialization succeed. Behavior is undefined if calling other LSPlant interfaces before initialization or after a fail initialization.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
2. Hook</h2>
<p>Hook a Java method by providing the <code>target_method</code> together with the context object <code>hooker_object</code> and its callback <code>callback_method</code>.</p>
<ul>
<li><code>env</code> is the Java environment.</li>
<li><code>target_method</code> is an <code>Method</code> object to the method you want to hook.</li>
<li><p class="startli"><code>hooker_object</code> is an object to store the context of the hook.</p>
<p class="startli">The most likely usage is to store the backup method into it so that when <code>callback_method</code> is invoked, it can call the original method. Another scenario is that, for example, in Xposed framework, multiple modules can hook the same Java method and the <code>hooker_object</code> can be used to store all the callbacks to allow multiple modules work simultaneously without conflict.</p>
</li>
<li><p class="startli"><code>callback_method</code> is an <code>Method</code> object, the callback method to the <code>hooker_object</code> used to replace the <code>target_method</code>.</p>
<p class="startli">Whenever the <code>target_method</code> is invoked, the callback_method will be invoked instead of the original <code>target_method</code>. The signature of the <code>callback_method</code> must be: <code>public Object callback_method(Object []args)</code>.</p>
<p class="startli">That is, the return type must be <code>Object</code> and the parameter type must be <code>Object[]</code>. Behavior is undefined if the signature does not match the requirement. Extra info can be provided by defining member variables of <code>hooker_object</code>. This method must be a method to <code>hooker_object</code>.</p>
</li>
</ul>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">jobject Hook(JNIEnv *env,</div>
<div class="line">             jobject target_method,</div>
<div class="line">             jobject hooker_object,</div>
<div class="line">             jobject callback_method);</div>
</div><!-- fragment --><p>Returns the backup method. You can invoke it by reflection to invoke the original method. null if fails.</p>
<p>This function will automatically generate a stub class for hook. To help debug, you can set the generated class name, its field name, its source name and its method name by setting <code>generated_*</code> in <code>InitInfo</code>.</p>
<p>This function thread safe (you can call it simultaneously from multiple thread) but it's not atomic to the same <code>target_method</code>. That means <code>UnHook</code> or <code>IsUnhook</code> does not guarantee to work properly on the same <code>target_method</code> before it returns. Also, simultaneously call on this function with the same target_method does not guarantee only one will success. If you call this with different <code>hooker_object</code> on the same <code>target_method</code> simultaneously, the behavior is undefined.</p>
<h2><a class="anchor" id="autotoc_md6"></a>
3. Check</h2>
<p>Check if a Java function is hooked by LSPlant or not.</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">bool IsHooked(JNIEnv *env,</div>
<div class="line">              jobject method);</div>
</div><!-- fragment --><p>Returns whether the method is hooked.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
4. Unhook</h2>
<p>Unhook a Java function that is previously hooked.</p>
<ul>
<li><code>env</code> is the Java environment.</li>
<li><code>target_method</code> is an <code>Method</code> object to the method you want to hook.</li>
</ul>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">bool UnHook(JNIEnv *env,</div>
<div class="line">            jobject target_method);</div>
</div><!-- fragment --><p>Returns whether the unhook succeed.</p>
<p>Calling backup (the return method of <code><a class="el" href="namespacelsplant_1_1v1.html#a5b0a35260c7845f862f06f40775b4b69" title="Hook a Java method by providing the target_method together with the context object hooker_object and ...">Hook()</a></code>) after unhooking is undefined behavior. Please read <code><a class="el" href="namespacelsplant_1_1v1.html#a5b0a35260c7845f862f06f40775b4b69" title="Hook a Java method by providing the target_method together with the context object hooker_object and ...">Hook()</a></code>'s note for more details.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
5. Deoptimize</h2>
<p>Deoptimize a method to avoid hooked callee not being called because of inline.</p>
<ul>
<li><code>env</code> is the Java environment.</li>
<li><p class="startli"><code>method</code> is an <code>Method</code> object to the method to deoptimize.</p>
<p class="startli">By deoptimizing the method, the method will back all callee without inlining. For example, if you hooked a short method B that is invoked by method A, and you find that your callback to B is not invoked after hooking, then it may mean A has inlined B inside its method body. To force A to call your hooked B, you can deoptimize A and then your hook can take effect. Generally, you need to find all the callers of your hooked callee and that can be hardly achieve. Use this function if you are sure the deoptimized callers are all you need. Otherwise, it would be better to change the hook point or to deoptimize the whole app manually (by simple reinstall the app without uninstalled).</p>
</li>
</ul>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">bool Deoptimize(JNIEnv *env,</div>
<div class="line">                jobject method);</div>
</div><!-- fragment --><p>Returns whether the deoptimizing succeed or not.</p>
<p>It is safe to call deoptimizing on a hooked method because the deoptimization will perform on the backup method instead.</p>
<h1><a class="anchor" id="autotoc_md9"></a>
Credits</h1>
<p>Inspired by the following frameworks:</p><ul>
<li><a href="https://github.com/PAGalaxyLab/YAHFA">YAHFA</a></li>
<li><a href="https://github.com/asLody/SandHook">SandHook</a></li>
<li><a href="https://github.com/canyie/pine">Pine</a></li>
<li><a href="https://github.com/tiann/epic">Epic</a> </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
